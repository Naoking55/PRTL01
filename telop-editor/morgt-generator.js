/**
 * MOGRT Generator - Motion Graphics Template File Generator
 * キャンバスデータからMOGRTファイル(Adobe Premiere Pro/After Effects モーショングラフィックステンプレート)を生成
 *
 * MOGRT形式仕様:
 * - ZIPベースのアーカイブ形式
 * - definition.json: テンプレートメタデータ
 * - project.aegraphic: After Effectsプロジェクトデータ（簡易実装）
 * - thumb.png: サムネイル画像
 */

class MORGTGenerator {
    constructor() {
        this.version = '1.0.0';
        this.templateId = this._generateId();
    }

    /**
     * キャンバスデータからMOGRT ZIPを生成
     * @param {Object} canvasData - キャンバスデータ {resolution, objects: textObjects[], name}
     * @param {HTMLCanvasElement} thumbnailCanvas - サムネイル用のキャンバス
     * @returns {Promise<Blob>} MOGRT形式のZIPファイル
     */
    async generateMOGRT(canvasData, thumbnailCanvas) {
        try {
            // JSZipライブラリの存在確認
            if (typeof JSZip === 'undefined') {
                throw new Error('JSZip library is not loaded. Please include JSZip in your HTML.');
            }

            const zip = new JSZip();
            const [width, height] = (canvasData.resolution || '1920x1080').split('x').map(Number);
            const objects = canvasData.objects || [];

            // 1. definition.jsonを生成
            const definition = this._buildDefinition(canvasData, width, height);
            zip.file('definition.json', JSON.stringify(definition, null, 2));

            // 2. project.aegraphicを生成（簡易JSON形式）
            const project = this._buildProjectData(canvasData, width, height);
            zip.file('project.aegraphic', JSON.stringify(project, null, 2));

            // 3. サムネイル画像を追加
            if (thumbnailCanvas) {
                const thumbnailBlob = await this._canvasToBlob(thumbnailCanvas);
                zip.file('thumb.png', thumbnailBlob);
            }

            // 4. メタデータファイルを追加
            const metadata = this._buildMetadata(canvasData);
            zip.file('metadata.json', JSON.stringify(metadata, null, 2));

            // ZIPファイルを生成
            const blob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: {
                    level: 9
                }
            });

            return blob;
        } catch (error) {
            console.error('MOGRT generation error:', error);
            throw error;
        }
    }

    /**
     * definition.jsonを構築（MOGRTのメタデータ定義）
     */
    _buildDefinition(canvasData, width, height) {
        const objects = canvasData.objects || [];

        return {
            version: '1.0',
            templateId: this.templateId,
            name: canvasData.name || 'Telop Template',
            description: 'Generated by Telop Editor',
            author: 'Telop Editor',
            createdDate: new Date().toISOString(),
            modifiedDate: new Date().toISOString(),
            dimensions: {
                width: width,
                height: height,
                pixelAspectRatio: 1.0,
                frameRate: 30
            },
            duration: canvasData.duration || 5000, // ミリ秒
            properties: this._buildProperties(objects),
            textLayers: this._buildTextLayers(objects),
            animations: this._buildAnimations(objects)
        };
    }

    /**
     * エクスポート可能なプロパティを構築
     */
    _buildProperties(objects) {
        const properties = [];

        objects.forEach((obj, index) => {
            if (obj.type === 'text' && obj.chars && obj.chars.length > 0) {
                const text = obj.chars.map(c => c.char).join('');

                // テキスト内容プロパティ
                properties.push({
                    id: `text_${index}`,
                    name: `テキスト ${index + 1}`,
                    type: 'text',
                    value: text,
                    maxLength: 500
                });

                // フォントサイズプロパティ
                const fontSize = obj.chars[0].fontSize || 48;
                properties.push({
                    id: `fontSize_${index}`,
                    name: `フォントサイズ ${index + 1}`,
                    type: 'number',
                    value: fontSize,
                    min: 10,
                    max: 500
                });

                // 色プロパティ
                const color = obj.chars[0].color || '#FFFFFF';
                properties.push({
                    id: `color_${index}`,
                    name: `テキストカラー ${index + 1}`,
                    type: 'color',
                    value: color
                });

                // 位置プロパティ
                properties.push({
                    id: `position_${index}`,
                    name: `位置 ${index + 1}`,
                    type: 'position',
                    value: { x: obj.x || 0, y: obj.y || 0 }
                });
            }
        });

        return properties;
    }

    /**
     * テキストレイヤー情報を構築
     */
    _buildTextLayers(objects) {
        return objects
            .filter(obj => obj.type === 'text')
            .map((obj, index) => {
                const firstChar = obj.chars && obj.chars[0] ? obj.chars[0] : {};

                return {
                    id: `layer_${index}`,
                    name: `Text Layer ${index + 1}`,
                    type: 'text',
                    text: obj.chars ? obj.chars.map(c => c.char).join('') : '',
                    position: {
                        x: obj.x || 0,
                        y: obj.y || 0
                    },
                    font: {
                        family: firstChar.fontFamily || 'Arial',
                        size: firstChar.fontSize || 48,
                        weight: firstChar.fontWeight || 'normal',
                        style: firstChar.fontStyle || 'normal'
                    },
                    fill: {
                        type: firstChar.fillType || 'solid',
                        color: firstChar.color || '#FFFFFF',
                        opacity: firstChar.opacity !== undefined ? firstChar.opacity : 1,
                        gradient: firstChar.gradientStops || null,
                        gradientAngle: firstChar.gradientAngle || 0
                    },
                    strokes: (firstChar.strokes || []).map(stroke => ({
                        color: stroke.color,
                        width: stroke.width,
                        opacity: stroke.opacity !== undefined ? stroke.opacity : 1,
                        enabled: stroke.enabled !== undefined ? stroke.enabled : true
                    })),
                    shadow: {
                        enabled: firstChar.shadowEnabled || false,
                        color: firstChar.shadowColor || '#000000',
                        opacity: firstChar.shadowOpacity || 0.5,
                        angle: firstChar.shadowAngle || 135,
                        distance: firstChar.shadowDistance || 10,
                        blur: firstChar.shadowBlur || 5
                    },
                    effects: {
                        glossEnabled: firstChar.glossEnabled || false,
                        glossHeight: firstChar.glossHeight || 50,
                        glossOpacity: firstChar.glossOpacity || 0.5
                    }
                };
            });
    }

    /**
     * アニメーション情報を構築
     */
    _buildAnimations(objects) {
        return objects
            .filter(obj => obj.type === 'text' && obj.presetKeyframes)
            .map((obj, index) => ({
                id: `anim_${index}`,
                layerId: `layer_${index}`,
                type: obj.animType || 'preset',
                duration: obj.animDuration || 1000,
                easing: obj.animEasing || 'linear',
                unit: obj.presetUnit || 'all',
                stagger: obj.presetStagger || 0,
                keyframes: obj.presetKeyframes || [],
                customKeyframes: obj.animKeyframes || []
            }));
    }

    /**
     * project.aegraphicデータを構築（簡易実装）
     */
    _buildProjectData(canvasData, width, height) {
        return {
            version: '1.0',
            format: 'aegraphic-simplified',
            note: 'This is a simplified After Effects project format generated by Telop Editor',
            composition: {
                name: canvasData.name || 'Main Comp',
                width: width,
                height: height,
                pixelAspect: 1.0,
                duration: canvasData.duration || 5000,
                frameRate: 30,
                backgroundColor: [0, 0, 0, 0] // 透過
            },
            layers: this._buildTextLayers(canvasData.objects || []),
            animations: this._buildAnimations(canvasData.objects || [])
        };
    }

    /**
     * メタデータを構築
     */
    _buildMetadata(canvasData) {
        return {
            generator: 'Telop Editor MOGRT Generator',
            version: this.version,
            generatedDate: new Date().toISOString(),
            sourceFormat: 'telop-editor-canvas',
            templateName: canvasData.name || 'Untitled',
            resolution: canvasData.resolution || '1920x1080',
            objectCount: (canvasData.objects || []).length,
            note: 'This MOGRT was generated from a browser-based telop editor. ' +
                  'For full compatibility, you may need to adjust settings in After Effects or Premiere Pro.'
        };
    }

    /**
     * CanvasをBlobに変換
     */
    _canvasToBlob(canvas) {
        return new Promise((resolve, reject) => {
            canvas.toBlob(blob => {
                if (blob) {
                    resolve(blob);
                } else {
                    reject(new Error('Failed to generate thumbnail blob'));
                }
            }, 'image/png');
        });
    }

    /**
     * ユニークIDを生成
     */
    _generateId() {
        return 'mogrt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    /**
     * ブラウザでのダウンロード用: MOGRTファイルをダウンロード
     */
    downloadMOGRT(blob, filename = 'telop.mogrt') {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

// グローバルに公開
if (typeof window !== 'undefined') {
    window.MORGTGenerator = MORGTGenerator;
}
