<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>テロップエディタ v1.0</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Yu Gothic UI', sans-serif; background: #2b2b2b; color: #ccc; display: flex; height: 100vh; }

        /* サイドバー */
        .sidebar { width: 300px; background: #383838; padding: 15px; overflow-y: auto; }
        .sidebar h3 { color: #fff; margin: 10px 0; font-size: 14px; }
        .sidebar label { display: block; margin: 8px 0 4px; font-size: 12px; }
        .sidebar input, .sidebar select, .sidebar textarea {
            width: 100%; padding: 6px; background: #4a4a4a; border: 1px solid #555;
            color: #fff; border-radius: 3px; font-size: 12px;
        }
        .sidebar textarea { height: 80px; resize: vertical; }
        .sidebar input[type="color"] { height: 30px; padding: 2px; cursor: pointer; }
        .sidebar input[type="range"] { padding: 0; }
        .btn {
            width: 100%; padding: 8px; margin: 5px 0; cursor: pointer;
            border: none; border-radius: 3px; font-size: 12px;
        }
        .btn-primary { background: #0078d4; color: #fff; }
        .btn-secondary { background: #4a4a4a; color: #fff; }
        .btn:hover { opacity: 0.9; }

        /* メインエリア */
        .main { flex: 1; display: flex; flex-direction: column; padding: 15px; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
        .canvas-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: #1a1a1a; border-radius: 5px; overflow: hidden;
        }
        #canvas {
            background: repeating-conic-gradient(#3a3a3a 0% 25%, #2a2a2a 0% 50%) 50% / 20px 20px;
            cursor: crosshair;
        }

        /* ステータスバー */
        .status { padding: 8px; background: #383838; font-size: 11px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>テキスト設定</h3>
        <label>テキスト</label>
        <textarea id="text">サンプルテキスト</textarea>

        <label>フォント</label>
        <select id="fontFamily">
            <option value="Yu Gothic UI">Yu Gothic UI</option>
            <option value="Meiryo">メイリオ</option>
            <option value="MS Gothic">MS ゴシック</option>
            <option value="Arial">Arial</option>
            <option value="Impact">Impact</option>
        </select>

        <label>サイズ: <span id="fontSizeVal">72</span>px</label>
        <input type="range" id="fontSize" min="12" max="200" value="72">

        <label>文字色</label>
        <input type="color" id="textColor" value="#ffffff">

        <h3>縁取り</h3>
        <label><input type="checkbox" id="strokeEnabled" checked> 有効</label>
        <label>色</label>
        <input type="color" id="strokeColor" value="#000000">
        <label>太さ: <span id="strokeWidthVal">4</span>px</label>
        <input type="range" id="strokeWidth" min="0" max="20" value="4">

        <h3>影</h3>
        <label><input type="checkbox" id="shadowEnabled"> 有効</label>
        <label>色</label>
        <input type="color" id="shadowColor" value="#000000">
        <label>ぼかし: <span id="shadowBlurVal">5</span>px</label>
        <input type="range" id="shadowBlur" min="0" max="30" value="5">
        <label>オフセットX: <span id="shadowXVal">3</span>px</label>
        <input type="range" id="shadowX" min="-20" max="20" value="3">
        <label>オフセットY: <span id="shadowYVal">3</span>px</label>
        <input type="range" id="shadowY" min="-20" max="20" value="3">

        <h3>位置</h3>
        <label>X: <span id="posXVal">960</span></label>
        <input type="range" id="posX" min="0" max="1920" value="960">
        <label>Y: <span id="posYVal">540</span></label>
        <input type="range" id="posY" min="0" max="1080" value="540">

        <h3>出力</h3>
        <button class="btn btn-primary" onclick="exportPNG()">PNG書き出し</button>
        <button class="btn btn-secondary" onclick="saveProject()">プロジェクト保存</button>
        <button class="btn btn-secondary" onclick="loadProject()">プロジェクト読込</button>
    </div>

    <div class="main">
        <div class="toolbar">
            <select id="resolution" onchange="changeResolution()">
                <option value="1920x1080">1920×1080 (HD)</option>
                <option value="3840x2160">3840×2160 (4K)</option>
            </select>
        </div>
        <div class="canvas-container">
            <canvas id="canvas" width="1920" height="1080"></canvas>
        </div>
        <div class="status">
            <span id="statusText">準備完了</span>
            <span id="resolution-display">1920×1080</span>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileLoad(event)">

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 設定要素
        const elements = {
            text: document.getElementById('text'),
            fontFamily: document.getElementById('fontFamily'),
            fontSize: document.getElementById('fontSize'),
            textColor: document.getElementById('textColor'),
            strokeEnabled: document.getElementById('strokeEnabled'),
            strokeColor: document.getElementById('strokeColor'),
            strokeWidth: document.getElementById('strokeWidth'),
            shadowEnabled: document.getElementById('shadowEnabled'),
            shadowColor: document.getElementById('shadowColor'),
            shadowBlur: document.getElementById('shadowBlur'),
            shadowX: document.getElementById('shadowX'),
            shadowY: document.getElementById('shadowY'),
            posX: document.getElementById('posX'),
            posY: document.getElementById('posY')
        };

        // 値表示更新
        ['fontSize', 'strokeWidth', 'shadowBlur', 'shadowX', 'shadowY', 'posX', 'posY'].forEach(id => {
            const el = document.getElementById(id);
            const valEl = document.getElementById(id + 'Val');
            el.addEventListener('input', () => { valEl.textContent = el.value; render(); });
        });

        // 他の入力でも再描画
        Object.values(elements).forEach(el => {
            el.addEventListener('input', render);
            el.addEventListener('change', render);
        });

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const text = elements.text.value;
            const fontSize = parseInt(elements.fontSize.value);
            const fontFamily = elements.fontFamily.value;
            const x = parseInt(elements.posX.value);
            const y = parseInt(elements.posY.value);

            ctx.font = `bold ${fontSize}px "${fontFamily}"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // 影
            if (elements.shadowEnabled.checked) {
                ctx.shadowColor = elements.shadowColor.value;
                ctx.shadowBlur = parseInt(elements.shadowBlur.value);
                ctx.shadowOffsetX = parseInt(elements.shadowX.value);
                ctx.shadowOffsetY = parseInt(elements.shadowY.value);
            } else {
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            // 複数行対応
            const lines = text.split('\n');
            const lineHeight = fontSize * 1.2;
            const startY = y - (lines.length - 1) * lineHeight / 2;

            lines.forEach((line, i) => {
                const ly = startY + i * lineHeight;

                // 縁取り
                if (elements.strokeEnabled.checked) {
                    ctx.strokeStyle = elements.strokeColor.value;
                    ctx.lineWidth = parseInt(elements.strokeWidth.value) * 2;
                    ctx.lineJoin = 'round';
                    ctx.strokeText(line, x, ly);
                }

                // 塗り
                ctx.fillStyle = elements.textColor.value;
                ctx.fillText(line, x, ly);
            });

            document.getElementById('statusText').textContent = `テキスト: ${text.substring(0, 20)}${text.length > 20 ? '...' : ''}`;
        }

        function changeResolution() {
            const [w, h] = document.getElementById('resolution').value.split('x').map(Number);
            canvas.width = w;
            canvas.height = h;
            elements.posX.max = w;
            elements.posY.max = h;
            document.getElementById('resolution-display').textContent = `${w}×${h}`;
            render();
        }

        function exportPNG() {
            const link = document.createElement('a');
            link.download = `telop_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            document.getElementById('statusText').textContent = 'PNG書き出し完了';
        }

        function saveProject() {
            const project = {
                version: '1.0',
                resolution: document.getElementById('resolution').value,
                text: elements.text.value,
                fontFamily: elements.fontFamily.value,
                fontSize: elements.fontSize.value,
                textColor: elements.textColor.value,
                strokeEnabled: elements.strokeEnabled.checked,
                strokeColor: elements.strokeColor.value,
                strokeWidth: elements.strokeWidth.value,
                shadowEnabled: elements.shadowEnabled.checked,
                shadowColor: elements.shadowColor.value,
                shadowBlur: elements.shadowBlur.value,
                shadowX: elements.shadowX.value,
                shadowY: elements.shadowY.value,
                posX: elements.posX.value,
                posY: elements.posY.value
            };

            const blob = new Blob([JSON.stringify(project, null, 2)], {type: 'application/json'});
            const link = document.createElement('a');
            link.download = `telop_project_${Date.now()}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
            document.getElementById('statusText').textContent = 'プロジェクト保存完了';
        }

        function loadProject() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);

                    if (project.resolution) {
                        document.getElementById('resolution').value = project.resolution;
                        changeResolution();
                    }

                    elements.text.value = project.text || '';
                    elements.fontFamily.value = project.fontFamily || 'Yu Gothic UI';
                    elements.fontSize.value = project.fontSize || 72;
                    elements.textColor.value = project.textColor || '#ffffff';
                    elements.strokeEnabled.checked = project.strokeEnabled !== false;
                    elements.strokeColor.value = project.strokeColor || '#000000';
                    elements.strokeWidth.value = project.strokeWidth || 4;
                    elements.shadowEnabled.checked = project.shadowEnabled || false;
                    elements.shadowColor.value = project.shadowColor || '#000000';
                    elements.shadowBlur.value = project.shadowBlur || 5;
                    elements.shadowX.value = project.shadowX || 3;
                    elements.shadowY.value = project.shadowY || 3;
                    elements.posX.value = project.posX || 960;
                    elements.posY.value = project.posY || 540;

                    // 値表示更新
                    ['fontSize', 'strokeWidth', 'shadowBlur', 'shadowX', 'shadowY', 'posX', 'posY'].forEach(id => {
                        document.getElementById(id + 'Val').textContent = document.getElementById(id).value;
                    });

                    render();
                    document.getElementById('statusText').textContent = 'プロジェクト読込完了';
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // 初期描画
        render();
    </script>
</body>
</html>
